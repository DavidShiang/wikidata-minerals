# .github/workflows/run_sparql.yml
name: Run Wikidata Query and Update Data

on:
  # æ¯æ—¥ UTC æ—¶é—´ 01:00 è¿è¡Œä¸€æ¬¡
  # schedule:
  #   - cron: '0 1 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-data:
    # ğŸŒŸ å…³é”®ä¿®æ­£ï¼šæ·»åŠ  permissions å—
    permissions:
      contents: write # èµ‹äºˆå¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ï¼Œå…è®¸ Bot æ¨é€æ–‡ä»¶
      
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç  (ä½¿ç”¨ token ç¡®ä¿æœ‰å†™å…¥æƒé™)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨å†…ç½®çš„ GITHUB_TOKENï¼Œå®ƒå…·æœ‰å†™å…¥æƒé™
          token: ${{ secrets.GITHUB_TOKEN }} 
          # è·å–å®Œæ•´çš„å†å²è®°å½•ï¼Œä»¥ä¾¿ Git æäº¤å·¥ä½œæ­£å¸¸
          fetch-depth: 0 

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. è¿è¡ŒæŸ¥è¯¢è„šæœ¬ (ç”Ÿæˆ minerals_data.csv)
      - name: Run SPARQL query and save CSV
        run: python run_query.py
        # å…è®¸è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œä½†æˆ‘ä»¬ä»å¸Œæœ›å°è¯•æäº¤ç°æœ‰æ•°æ® (å¯é€‰ï¼Œè¿™é‡Œå‡è®¾æˆåŠŸ)

      # 5. é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Configure Git
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'github-actions[at]users.noreply.github.com' # å®˜æ–¹æ¨èçš„ bot é‚®ç®±æ ¼å¼

      # 6. æäº¤å¹¶æ¨é€ç»“æœæ–‡ä»¶ (ä½¿ç”¨æ ‡å‡† Git å‘½ä»¤)
      - name: Commit and push changes
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å®é™…å˜åŒ–
          git add minerals_data.csv
          git diff --staged --quiet || (git commit -m "Automated data update: Minerals/Gemstones data" && git push)
        env:
          # ç¡®ä¿ GITHUB_TOKEN å¯ç”¨
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. (å¯é€‰) ä¸Šä¼ ç”Ÿæˆçš„æ–‡ä»¶ä½œä¸º Action Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: minerals-data-csv
          path: minerals_data.csv
